{% extends 'base.html' %}

{% block title %}Map - Twitter{% endblock %} 

{% block extra_css %}
<!-- Leaflet.js untuk Map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    .map-header {
        padding: 16px 20px;
        border-bottom: 1px solid #E1E8ED;
        position: sticky;
        top: 0;
                         // Create enhanced popup content
                    const popupContent = `
                        <div class="custom-popup">
                            <div class="popup-header">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <div style="width: 32px; height: 32px; background: #1DA1F2; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">
                                        ${tweet.user.charAt(0).toUpperCase()}
                                    </div>
                                    <div>
                                        <strong style="display: block; color: #14171A;">@${tweet.user}</strong>
                                        <small style="color: #657786; font-size: 11px;">${tweet.tanggal} ‚Ä¢ ${tweet.waktu}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="popup-content" style="margin: 12px 0; color: #14171A; font-size: 14px; line-height: 1.4;">
                                ${tweet.pesan}
                            </div>
                            <div class="popup-location" style="display: flex; align-items: center; gap: 4px; color: #657786; font-size: 12px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #E1E8ED;">
                                <span>üìç</span>
                                <span>${tweet.lokasi}</span>
                            </div>
                            ${tweet.foto ? `
                                <div class="popup-image" style="margin-top: 12px;">
                                    <img src="${tweet.foto}" style="max-width: 220px; width: 100%; border-radius: 8px; border: 1px solid #E1E8ED; cursor: pointer;" 
                                         onclick="window.open('${tweet.foto}', '_blank')" 
                                         title="Click to view full size">
                                </div>
                            ` : ''}
                            <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #E1E8ED;">
                                <button onclick="window.location.href='/map/?tweet_id=${tweet.id}'" 
                                        style="background: #1DA1F2; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer; font-weight: 500;">
                                    View Details
                                </button>
                                <span style="color: #657786; font-size: 11px; margin-left: 8px;">ID: ${tweet.id}</span>
                            </div>
                        </div>
                    `;nd: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        z-index: 100;
    }
    
    .map-header h4 {
        margin: 0;
        font-size: 20px;
        font-weight: 800;
        color: #14171A;
    }
    
    .map-container {
        position: relative;
        height: 70vh;
        min-height: 400px;
        border-bottom: 1px solid #E1E8ED;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .map-header {
            flex-direction: column;
            gap: 15px;
            align-items: stretch !important;
        }
        
        .map-controls {
            flex-direction: column;
            gap: 10px;
        }
        
        .search-box input {
            width: 100% !important;
        }
        
        .map-container {
            height: 60vh;
            min-height: 350px;
        }
        
        .map-stats .col-md-3 {
            margin-bottom: 15px;
        }
    }

    @media (max-width: 576px) {
        .map-header h4 {
            font-size: 1.2rem;
        }
        
        .map-controls .btn {
            font-size: 11px !important;
            padding: 5px 10px !important;
        }
        
        .search-box input {
            font-size: 12px !important;
            padding: 7px 30px 7px 10px !important;
        }
    }
    
    #map {
        height: 100%;
        width: 100%;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    
    /* Custom popup styling untuk map */
    .leaflet-popup-content-wrapper {
        border-radius: 15px !important;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
        border: 1px solid rgba(29, 161, 242, 0.1) !important;
    }
    
    .custom-popup {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif !important;
        line-height: 1.4 !important;
        max-width: 280px !important;
    }
    
    .popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px solid #E1E8ED;
    }
    
    .popup-header strong {
        color: #1DA1F2 !important;
        font-weight: 600 !important;
    }
    
    .popup-header small {
        color: #657786 !important;
        font-size: 12px !important;
    }
    
    .popup-content {
        margin: 8px 0 !important;
        color: #14171A !important;
        font-size: 14px !important;
    }
    
    .popup-location {
        color: #657786 !important;
        font-size: 12px !important;
        margin-top: 6px !important;
    }
    
    .popup-image img {
        transition: transform 0.2s ease !important;
    }
    
    .popup-image img:hover {
        transform: scale(1.05) !important;
    }
    
    .highlight-badge {
        background: linear-gradient(135deg, #E91E63, #F06292) !important;
        color: white !important;
        padding: 2px 8px !important;
        border-radius: 12px !important;
        font-size: 10px !important;
        font-weight: 600 !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
        margin-top: 4px !important;
    }
    
    .specific-popup .leaflet-popup-content-wrapper {
        background: linear-gradient(135deg, rgba(233, 30, 99, 0.05), rgba(240, 98, 146, 0.05)) !important;
        border: 2px solid #E91E63 !important;
    }
    
    .tweet-detail {
        padding: 20px;
        border-bottom: 1px solid #E1E8ED;
    }
    
    .tweet-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 20px;
        border: 1px solid rgba(225, 232, 237, 0.5);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .tweet-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    
    .tweet-avatar {
        width: 48px;
        height: 48px;
        background: #1DA1F2;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
    }
    
    .tweet-user-info h5 {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        color: #14171A;
    }
    
    .tweet-user-info p {
        margin: 0;
        font-size: 14px;
        color: #657786;
    }
    
    .tweet-content {
        color: #14171A;
        font-size: 16px;
        line-height: 1.4;
        margin-bottom: 16px;
    }
    
    .tweet-image {
        margin: 16px 0;
    }
    
    .tweet-image img {
        max-width: 100%;
        height: auto;
        border-radius: 12px;
        border: 1px solid #E1E8ED;
    }
    
    .tweet-meta {
        color: #657786;
        font-size: 14px;
        line-height: 1.6;
    }
    
    .tweet-meta strong {
        color: #14171A;
    }
    
    .delete-btn {
        background: none;
        border: none;
        color: #E91E63;
        cursor: pointer;
        font-size: 12px;
        padding: 0;
        margin-top: 8px;
        display: inline-block;
    }
    
    .delete-btn:hover {
        text-decoration: underline;
    }
    
    .map-instructions {
        padding: 20px;
        text-align: center;
        color: #657786;
        background: rgba(247, 249, 250, 0.8);
        backdrop-filter: blur(10px);
    }
    
    .map-instructions h6 {
        font-size: 18px;
        font-weight: 700;
        color: #14171A;
        margin-bottom: 8px;
    }
    
    .map-instructions p {
        margin-bottom: 0;
        font-size: 14px;
    }
    
    /* Custom Leaflet popup styles */
    .custom-popup .leaflet-popup-content-wrapper {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        border: 1px solid rgba(225, 232, 237, 0.5);
    }
    
    .custom-popup .leaflet-popup-content {
        margin: 16px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }
    
    .popup-username {
        font-weight: 700;
        color: #14171A;
        font-size: 14px;
    }
    
    .popup-content {
        color: #14171A;
        margin: 8px 0;
        font-size: 13px;
        line-height: 1.4;
    }
    
    .popup-location {
        color: #657786;
        font-size: 12px;
    }
    
    /* Enhanced popup styles */
    .leaflet-popup-content {
        margin: 16px !important;
        line-height: 1.5 !important;
    }
    
    .leaflet-popup-tip {
        border-top-color: rgba(255, 255, 255, 0.95) !important;
    }
    
    /* Custom marker hover effect */
    .custom-tweet-marker:hover {
        transform: scale(1.1);
        transition: transform 0.2s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="map-header d-flex justify-content-between align-items-center">
    <h4 class="mb-0">üó∫Ô∏è Tweet Locations</h4>
    
    <!-- Search/Filter controls -->
    <div class="map-controls d-flex gap-2">
        <div class="search-box" style="position: relative;">
            <input type="text" id="mapSearch" placeholder="Search tweets or locations..." 
                   style="padding: 8px 35px 8px 12px; border: 1px solid #E1E8ED; border-radius: 20px; font-size: 13px; width: 250px; outline: none; transition: all 0.3s ease;">
            <i class="fas fa-search" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #657786; font-size: 12px;"></i>
        </div>
        
        <button id="clearSearch" class="btn btn-sm btn-outline-secondary d-none" style="border-radius: 20px; padding: 6px 12px; font-size: 12px;">
            <i class="fas fa-times"></i> Clear
        </button>
        
        <button id="showAllTweets" class="btn btn-sm btn-outline-primary" style="border-radius: 20px; padding: 6px 12px; font-size: 12px;">
            <i class="fas fa-eye"></i> Show All
        </button>
    </div>
</div>

<div class="map-container">
    <div id="map"></div>
</div>

<!-- Map Statistics Panel -->
<div class="map-stats mt-4" style="display: none;">
    <div class="row">
        <div class="col-md-3">
            <div class="stat-card text-center p-3" style="background: linear-gradient(135deg, #1DA1F2, #0D8BF0); border-radius: 15px; color: white;">
                <div style="font-size: 28px; font-weight: 700;" id="totalTweets">0</div>
                <div style="font-size: 12px; opacity: 0.9;">Total Tweets</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center p-3" style="background: linear-gradient(135deg, #17BF63, #0EA348); border-radius: 15px; color: white;">
                <div style="font-size: 28px; font-weight: 700;" id="uniqueLocations">0</div>
                <div style="font-size: 12px; opacity: 0.9;">Unique Locations</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center p-3" style="background: linear-gradient(135deg, #FF6B6B, #EE5A52); border-radius: 15px; color: white;">
                <div style="font-size: 28px; font-weight: 700;" id="activeUsers">0</div>
                <div style="font-size: 12px; opacity: 0.9;">Active Users</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card text-center p-3" style="background: linear-gradient(135deg, #FFA726, #FF9800); border-radius: 15px; color: white;">
                <div style="font-size: 28px; font-weight: 700;" id="currentView">0</div>
                <div style="font-size: 12px; opacity: 0.9;">Currently Visible</div>
            </div>
        </div>
    </div>
</div>

{% if tweet %}
<div class="tweet-detail">
    <div class="tweet-card">
        <div class="tweet-header">
            <div class="tweet-avatar">{{ tweet.user.username|first|upper }}</div>
            <div class="tweet-user-info">
                <h5>{{ tweet.user.username }}</h5>
                <p>@{{ tweet.user.username|lower }} ¬∑ {{ tweet.created_at|timesince }} ago</p>
            </div>
        </div>
        
        <div class="tweet-content">{{ tweet.content }}</div>
        
        {% if tweet.image %}
        <div class="tweet-image">
            <img src="{{ tweet.image.url }}" alt="Tweet image">
        </div>
        {% endif %}
        
        <div class="tweet-meta">
            üìç <strong>Location:</strong> {{ tweet.location }}<br>
            üìÖ <strong>Date:</strong> {{ tweet.created_at|date:"d M Y" }}<br>
            ‚è∞ <strong>Time:</strong> {{ tweet.created_at|time:"H:i" }}<br>
            {% if tweet.latitude and tweet.longitude %}
            üåê <strong>Coordinates:</strong> {{ tweet.latitude }}, {{ tweet.longitude }}<br>
            {% endif %}
            {% if tweet.user == user %}
                <form method="post" action="{% url 'delete_tweet' tweet.id %}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this tweet?');">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="map">
                    <button type="submit" class="delete-btn">üóëÔ∏è Delete Tweet</button>
                </form>
            {% endif %}
        </div>
    </div>
</div>
{% else %}
<div class="map-instructions">
    <h6>Explore Tweet Locations</h6>
    <p>View tweets on the map by clicking on the markers. Each marker represents a tweet with location data.</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- Leaflet.js -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Django data untuk JavaScript -->
<script id="map-data" type="application/json">
{
    "specificTweet": {% if tweet and tweet.latitude and tweet.longitude %}{
        "latitude": {{ tweet.latitude }},
        "longitude": {{ tweet.longitude }},
        "user": "{{ tweet.user.username|escapejs }}",
        "content": "{{ tweet.content|escapejs }}",
        "location": "{{ tweet.location|escapejs }}",
        "date": "{{ tweet.created_at|date:'d M Y' }}",
        "time": "{{ tweet.created_at|time:'H:i' }}"
    }{% else %}null{% endif %}
}
</script>

<script>
$(document).ready(function() {
    // Get Django data
    const mapData = JSON.parse(document.getElementById('map-data').textContent);
    
    // Initialize map
    const map = L.map('map').setView([-2.5489, 118.0149], 5); // Indonesia center
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // Custom icon untuk tweet markers
    const tweetIcon = L.divIcon({
        className: 'custom-tweet-marker',
        html: '<div style="background: #1DA1F2; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 8px rgba(29,161,242,0.3);">üê¶</div>',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });
    
    // Store all markers and tweets for reference
    let allMarkers = [];
    let allTweets = [];
    let specificMarker = null;
    let filteredMarkers = [];
    
    // Add loading indicator
    const loadingControl = L.control({position: 'topleft'});
    loadingControl.onAdd = function() {
        const div = L.DomUtil.create('div', 'loading-control');
        div.innerHTML = `
            <div style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 16px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid rgba(29, 161, 242, 0.1);">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="spinner" style="width: 20px; height: 20px; border: 2px solid #E1E8ED; border-top: 2px solid #1DA1F2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <div>
                        <div style="font-weight: 600; color: #14171A; font-size: 13px;">Loading tweets...</div>
                        <div style="color: #657786; font-size: 11px;">Fetching location data</div>
                    </div>
                </div>
            </div>
        `;
        return div;
    };
    loadingControl.addTo(map);

    // Add loading animation styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    `;
    document.head.appendChild(style);

    // Fetch tweets with location data
    $.get('/api/posts/')
        .done(function(response) {
            // Remove loading indicator
            map.removeControl(loadingControl);
            if (response.status === 'success' && response.data) {
                // Filter tweets that have location data
                const tweetsWithLocation = response.data.filter(tweet => 
                    tweet.latitude && tweet.longitude
                );
                
                // Store all tweets for search functionality
                allTweets = tweetsWithLocation;
                
                console.log(`Found ${tweetsWithLocation.length} tweets with location data`);
                
                tweetsWithLocation.forEach(function(tweet) {
                    const marker = L.marker([tweet.latitude, tweet.longitude], {
                        icon: tweetIcon
                    }).addTo(map);
                    
                    const popupContent = `
                        <div class="custom-popup">
                            <div class="popup-header">
                                <strong>@${tweet.user}</strong>
                                <small>${tweet.tanggal} ${tweet.waktu}</small>
                            </div>
                            <div class="popup-content">${tweet.pesan}</div>
                            <div class="popup-location">ÔøΩ ${tweet.lokasi}</div>
                            ${tweet.foto ? `<div class="popup-image"><img src="${tweet.foto}" style="max-width: 200px; width: 100%; border-radius: 8px; margin-top: 8px;"></div>` : ''}
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent, {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });
                    
                    // Add hover effect for better user experience
                    marker.on('mouseover', function() {
                        this.openPopup();
                    });
                    
                    // Add click to focus
                    marker.on('click', function() {
                        map.setView([tweet.latitude, tweet.longitude], 15);
                    });
                    
                    // Store marker reference
                    allMarkers.push({
                        marker: marker,
                        tweet: tweet
                    });
                });
                
                // If no tweets with location, show message
                if (tweetsWithLocation.length === 0) {
                    const noDataPopup = L.popup()
                        .setLatLng([-2.5489, 118.0149])
                        .setContent('<div style="text-align: center; padding: 10px;"><strong>No tweets with location data found</strong><br>Post a tweet with location to see it on the map!</div>')
                        .openOn(map);
                }
                
                // Handle specific tweet if provided
                if (mapData.specificTweet) {
                    const tweet = mapData.specificTweet;
                    // Focus to specific tweet location
                    map.setView([tweet.latitude, tweet.longitude], 15);
                    
                    // Create highlighted marker for specific tweet
                    specificMarker = L.marker([tweet.latitude, tweet.longitude], {
                        icon: L.divIcon({
                            className: 'specific-tweet-marker',
                            html: '<div style="background: linear-gradient(135deg, #E91E63, #F06292); color: white; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; border: 4px solid white; box-shadow: 0 6px 20px rgba(233,30,99,0.4); animation: pulse 2s infinite;">üìç</div>',
                            iconSize: [50, 50],
                            iconAnchor: [25, 25]
                        })
                    }).addTo(map);
                    
                    const specificPopupContent = `
                        <div class="custom-popup specific-popup">
                            <div class="popup-header">
                                <strong>@${tweet.user}</strong>
                                <small>${tweet.date} ${tweet.time}</small>
                                <div class="highlight-badge">üìå Selected Tweet</div>
                            </div>
                            <div class="popup-content">${tweet.content}</div>
                            <div class="popup-location">ÔøΩ ${tweet.location}</div>
                        </div>
                    `;
                    
                    specificMarker.bindPopup(specificPopupContent, {
                        maxWidth: 300,
                        className: 'custom-popup specific-popup'
                    }).openPopup();
                } else if (tweetsWithLocation.length > 0) {
                    // If no specific tweet, fit map to show all markers
                    const group = new L.featureGroup(allMarkers.map(m => m.marker));
                    try {
                        map.fitBounds(group.getBounds().pad(0.1));
                    } catch (e) {
                        // Fallback to center of Indonesia if bounds calculation fails
                        map.setView([-2.5489, 118.0149], 5);
                    }
                    
                    // Add fade-in animation to markers
                    setTimeout(() => {
                        allMarkers.forEach((marker, index) => {
                            setTimeout(() => {
                                const markerElement = marker.getElement();
                                if (markerElement) {
                                    markerElement.classList.add('fade-in');
                                }
                            }, index * 100); // Staggered animation
                        });
                    }, 100);

                    // Add tweet count info control
                    if (tweetsWithLocation.length > 0) {
                        const infoControl = L.control({position: 'topright'});
                        infoControl.onAdd = function() {
                            const div = L.DomUtil.create('div', 'tweet-count-info');
                            div.innerHTML = `
                                <div style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid rgba(29, 161, 242, 0.1);">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 18px;">üó∫Ô∏è</span>
                                        <div>
                                            <div style="font-weight: 700; color: #14171A; font-size: 14px;">${tweetsWithLocation.length} Tweet${tweetsWithLocation.length > 1 ? 's' : ''}</div>
                                            <div style="color: #657786; font-size: 11px;">with location data</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            return div;
                        };
                        infoControl.addTo(map);
                        
                        // Add legend control
                        const legendControl = L.control({position: 'bottomleft'});
                        legendControl.onAdd = function() {
                            const div = L.DomUtil.create('div', 'map-legend');
                            div.innerHTML = `
                                <div style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 12px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid rgba(29, 161, 242, 0.1);">
                                    <div style="font-weight: 600; color: #14171A; font-size: 12px; margin-bottom: 8px;">üìç Legend</div>
                                    <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: #657786;">
                                        <div style="width: 16px; height: 16px; background: #1DA1F2; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 8px;">üê¶</div>
                                        <span>Tweet Location</span>
                                    </div>
                                    <div style="margin-top: 6px; font-size: 10px; color: #657786;">
                                        Click markers for details ‚Ä¢ Hover to preview
                                    </div>
                                </div>
                            `;
                            return div;
                        };
                        legendControl.addTo(map);
                        
                        // Calculate and display statistics
                        updateStatistics(tweetsWithLocation);
                        
                        // Show stats panel
                        $('.map-stats').fadeIn();
                    }
                }
            }
        })
        .fail(function(xhr, status, error) {
            // Remove loading indicator
            map.removeControl(loadingControl);
            
            // Show error message
            const errorControl = L.control({position: 'topleft'});
            errorControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'error-control');
                div.innerHTML = `
                    <div style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 16px 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 1px solid rgba(220, 53, 69, 0.3);">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">‚ö†Ô∏è</span>
                            <div>
                                <div style="font-weight: 600; color: #DC3545; font-size: 13px;">Failed to load tweets</div>
                                <div style="color: #6C757D; font-size: 11px;">Unable to fetch location data</div>
                            </div>
                        </div>
                        <button onclick="location.reload()" style="margin-top: 8px; padding: 6px 12px; background: #1DA1F2; color: white; border: none; border-radius: 6px; font-size: 11px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
                return div;
            };
            errorControl.addTo(map);
            
            // Auto-remove error after 10 seconds
            setTimeout(() => {
                if (map.hasLayer(errorControl)) {
                    map.removeControl(errorControl);
                }
            }, 10000);
            console.error('Failed to load tweet locations');
        });

    // Search functionality
    function filterTweets(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        
        if (!term) {
            showAllMarkers();
            return;
        }

        // Hide all markers first  
        allMarkers.forEach(marker => {
            map.removeLayer(marker);
        });

        // Filter tweets based on search term
        filteredMarkers = [];
        allTweets.forEach((tweet, index) => {
            const matchesUser = tweet.user.toLowerCase().includes(term);
            const matchesContent = tweet.content.toLowerCase().includes(term);
            const matchesLocation = tweet.location && tweet.location.toLowerCase().includes(term);
            
            if (matchesUser || matchesContent || matchesLocation) {
                const marker = allMarkers[index];
                if (marker) {
                    map.addLayer(marker);
                    filteredMarkers.push(marker);
                }
            }
        });

        // Update info display
        updateMapInfo(filteredMarkers.length, `matching "${searchTerm}"`);
    }

    function showAllMarkers() {
        // Show all markers
        allMarkers.forEach(marker => {
            if (!map.hasLayer(marker)) {  
                map.addLayer(marker);
            }
        });
        filteredMarkers = [...allMarkers];
        updateMapInfo(allMarkers.length, 'with location data');
    }

    function updateMapInfo(count, description) {
        // Find and update the info control
        const infoControls = document.querySelectorAll('.tweet-count-info');
        infoControls.forEach(control => {
            const div = control.querySelector('div > div:first-child');
            if (div) {
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 18px;">üó∫Ô∏è</span>
                        <div>
                            <div style="font-weight: 700; color: #14171A; font-size: 14px;">${count} Tweet${count !== 1 ? 's' : ''}</div>
                            <div style="color: #657786; font-size: 11px;">${description}</div>
                        </div>
                    </div>
                `;
            }
        });
        
        // Update current view stat
        $('#currentView').text(count);
    }

    function updateStatistics(tweets) {
        const totalTweets = tweets.length;
        const uniqueLocations = new Set(tweets.map(t => `${t.latitude},${t.longitude}`)).size;
        const activeUsers = new Set(tweets.map(t => t.user)).size;
        
        // Animate counters
        animateCounter('#totalTweets', totalTweets);
        animateCounter('#uniqueLocations', uniqueLocations);
        animateCounter('#activeUsers', activeUsers);
        animateCounter('#currentView', totalTweets);
    }

    function animateCounter(selector, targetValue) {
        const element = $(selector);
        const startValue = 0;
        const duration = 1500;
        const increment = targetValue / (duration / 50);
        let currentValue = startValue;
        
        const timer = setInterval(() => {
            currentValue += increment;
            if (currentValue >= targetValue) {
                currentValue = targetValue;
                clearInterval(timer);
            }
            element.text(Math.floor(currentValue));
        }, 50);
    }

    // Event listeners for search
    $(document).ready(function() {
        const searchInput = $('#mapSearch');
        const clearBtn = $('#clearSearch');
        const showAllBtn = $('#showAllTweets');

        // Real-time search
        searchInput.on('input', function() {
            const searchTerm = $(this).val();
            
            if (searchTerm.length > 0) {
                clearBtn.removeClass('d-none');
                filterTweets(searchTerm);
            } else {
                clearBtn.addClass('d-none');
                showAllMarkers();
            }
        });

        // Clear search
        clearBtn.on('click', function() {
            searchInput.val('');
            $(this).addClass('d-none');
            showAllMarkers();
        });

        // Show all tweets  
        showAllBtn.on('click', function() {
            searchInput.val('');
            clearBtn.addClass('d-none');
            showAllMarkers();
            
            // Fit map to show all markers
            if (allMarkers.length > 0) {
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        });

        // Enhanced search input styling
        searchInput.on('focus', function() {
            $(this).css({
                'border-color': '#1DA1F2',
                'box-shadow': '0 0 0 3px rgba(29, 161, 242, 0.1)'
            });
        });

        searchInput.on('blur', function() {
            $(this).css({
                'border-color': '#E1E8ED',
                'box-shadow': 'none'
            });
        });
    });
});

// Add pulse animation for specific marker
const style = document.createElement('style');
style.textContent = `
    @keyframes pulse {
        0% {
            box-shadow: 0 4px 12px rgba(233,30,99,0.4);
        }
        50% {
            box-shadow: 0 4px 20px rgba(233,30,99,0.7);
        }
        100% {
            box-shadow: 0 4px 12px rgba(233,30,99,0.4);
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}